(function(){var t=function(t,e){return function(){return t.apply(e,arguments)}},e={}.hasOwnProperty,i=function(t,i){function o(){this.constructor=t}for(var n in i)e.call(i,n)&&(t[n]=i[n]);return o.prototype=i.prototype,t.prototype=new o,t.__super__=i.prototype,t};Tapjoy.GeoLocation=function(e){function o(){return this.radiusFromMap=t(this.radiusFromMap,this),this.formatAddress=t(this.formatAddress,this),this.createMarker=t(this.createMarker,this),this.placesCallback=t(this.placesCallback,this),this.setUpMarkerInfoWindow=t(this.setUpMarkerInfoWindow,this),this.drawMarkers=t(this.drawMarkers,this),this.markerDataCallBack=t(this.markerDataCallBack,this),this.getMarkerData=t(this.getMarkerData,this),this.findPlaces=t(this.findPlaces,this),this.buildMap=t(this.buildMap,this),this.locationFromZip=t(this.locationFromZip,this),this.zipSearch=t(this.zipSearch,this),this.expand=t(this.expand,this),this.contract=t(this.contract,this),this.resize=t(this.resize,this),this.permissionResult=t(this.permissionResult,this),this.locationUpdated=t(this.locationUpdated,this),this.closeRequested=t(this.closeRequested,this),this.initialize=t(this.initialize,this),o.__super__.constructor.apply(this,arguments)}return i(o,e),o.prototype.STARTING_RADIUS=1e3,o.prototype.initialize=function(){var t=this;return window.geoEndCard=this,Tapjoy.AdUnit.configure({impression_url:null}),google.maps.visualRefresh=!0,this.searchTerm=this.offer.attributes.searchTerm||function(){throw"searchTerm needed"}(),this.radius=this.STARTING_RADIUS,this.ipad=/.*iPad.*/.test(navigator.userAgent),this.chromeBackgroundColor=this.offer.attributes.chromeBackgroundColor,this.locationFeedUrl=this.offer.attributes.locationFeedUrl,this.pinImage=this.offer.attributes.pinImage,this.setAllowRedirect(!0,function(){}),$.os.android?$(window).on("resize",this.resize):$(window).on("orientationchange",this.resize),$.os.android||$.os.ios&&Number($.os.version)<8?this.getLocation({enabled:!0},this.permissionResult):this.permissionResult(!1),$(".bottom").css("background-color",this.chromeBackgroundColor),this.element.on("tap","button.navigate",function(t){return $("<a/>").attr("href",$(t.currentTarget).attr("link")).appendTo($("body")).trigger("click")}),this.element.find(".bottom").on("swipeUp",this.expand),this.element.find(".bottom").on("swipeDown",function(){return t.element.find(".search .zip").blur(),setTimeout(function(){return t.contract()},0)}),this.element.find(".search-button").on("click",this.expand),this.element.find("#map-canvas").on("mousedown",this.contract),this.compareVersions($.os.version,"7")>=0&&this.element.find(".bottom").css("position","absolute"),$.os.android&&(this.element.find(".mapPlaceHolder .android").show(),this.element.find(".mapPlaceHolder .ios").hide(),this.element.find(".bottom").css("position","absolute"),this.compareVersions($.os.version,"4.1.1")>=0&&this.element.find(".search .zip").on("focusin",function(){return setTimeout(function(){return $(".bottom").css("top",$(window).height()<$(window).width()?"0px":"100px")},0)}).on("blur",function(){return setTimeout(function(){return $(".bottom").css("top","auto")},0)})),$(".expand form").on("submit",function(e){return $(".bottom").css("top","auto"),e.preventDefault(),t.element.find(".search .zip").blur(),setTimeout(function(){return t.contract()},0),t.zipSearch()}),this.present({visible:!0,customClose:!0},function(){})},o.prototype.closeRequested=function(){var t=this;return this.shouldClose(!1),setTimeout(function(){return"offerwall"===t.offer.attributes.source&&$.os.ios||t.offer.attributes.tjcAsSource===!0?($("<a/>").attr("href",t.offer.attributes.offerwall_url).appendTo($("body")).trigger("click"),t.closeRequested=e.closeRequested):t.dismiss()},0)},o.prototype.compareVersions=function(t,e){var i,o,n;for(o=t.split("."),n=e.split("."),i=0;o[i]&&n[i];){if(o[i]!==n[i])return o[i]-n[i];i++}return o.length-n.length},o.prototype.locationUpdated=function(t){return this.getLocation({enabled:!1},function(){}),this.user_location=new google.maps.LatLng(t.lat,t.long),this.buildMap(!0)},o.prototype.permissionResult=function(t){return this.element.find(".bottom.explain").hide(),this.element.find(".bottom.map-view").show(),this.bottom_height=this.element.find(".bottom.map-view").height(),this.resize(),t?(this.element.find(".prompt").hide(),this.element.find(".tagline").show(),this.element.find(".loading").css("display","table-cell"),this.element.find(".topLeft.tapjoy").show(),this.element.find(".mapPlaceHolder").hide()):(this.element.find(".mapPlaceHolder").show(),this.expand())},o.prototype.resize=function(){return this.expand_size=$(".expand").height()+5,$("#map-canvas").height($(window).height()-this.bottom_height+this.expand_size),$("#map-canvas").width($(window).width()),$.os.android&&$(".search .zip").is(":focus")?$(".search .zip").trigger("focusin"):this.contract()},o.prototype.contract=function(){return this.element.find(".bottom").css("-webkit-transform","translateY("+this.expand_size+"px)"),$(".bottom").css("top","auto")},o.prototype.expand=function(){return this.element.find(".bottom").css("-webkit-transform","translateY(0)")},o.prototype.zipSearch=function(){var t,e=this;return t=$(".expand .zip").val(),this.locationFromZip(t,function(t){return e.radius=e.STARTING_RADIUS,e.expandedSearch=!1,e.user_location=t,e.buildMap(!1)})},o.prototype.locationFromZip=function(t,e){var i,o=this;return i=new google.maps.Geocoder,i.geocode({address:t},function(t,i){return i===google.maps.GeocoderStatus.OK?e(t[0].geometry.location):(o.alert("Invalid Search","Please enter a valid zip-code",["OK"],function(){}),o.expand())})},o.prototype.buildMap=function(t){var e,i,o,n=this;return this.mapBuilt||(e=new Image,i=t?"geo_location_lat_long":"geo_location_zipcode",e.src=this.offer.attributes.impressionURL+"&geo_location_type="+i,this.element.find(".topLeft.tapjoy").show(),this.getLocation({enabled:!1},function(){}),this.element.find(".prompt").hide(),this.element.find(".tagline").show(),this.center=this.user_location,this.map=new google.maps.Map(document.getElementById("map-canvas"),{mapTypeId:google.maps.MapTypeId.ROADMAP,center:this.user_location,streetViewControl:!1,mapTypeControl:!1,zoom:15}),google.maps.event.addListener(this.map,"zoom_changed",function(){var t;return t=n.radiusFromMap()/2,t>n.radius&&n.radius<5e4?n.radius=t:void 0}),google.maps.event.addListener(this.map,"center_changed",function(){return!n.isSearching&&google.maps.geometry.spherical.computeDistanceBetween(n.center,n.map.getCenter())>n.radius?(n.center=n.map.getCenter(),n.user_location=n.center):void 0}),t&&(o=new google.maps.Marker({clickable:!1,icon:new google.maps.MarkerImage("//maps.gstatic.com/mapfiles/mobile/mobileimgs2.png",new google.maps.Size(22,22),new google.maps.Point(0,18),new google.maps.Point(11,11)),shadow:null,zIndex:999,map:this.map,position:this.user_location})),this.infowindow=new google.maps.InfoWindow,this.service=new google.maps.places.PlacesService(this.map),this.mapBuilt=!0),this.getMarkerData()},o.prototype.findPlaces=function(t,e){var i,o=this;return this.radius=t,this.isSearching=!0,i={location:this.user_location,radius:t,rankby:"distance",name:this.searchTerm},this.service.nearbySearch(i,function(t,i){return o.placesCallback(t,i,e)})},o.prototype.getMarkerData=function(){return $.ajax({url:this.locationFeedUrl,dataType:"jsonp",jsonpCallback:"window.geoEndCard.markerDataCallBack",jsonp:"jsonp",data:{limit:50,loc:this.user_location.toUrlValue()}})},o.prototype.markerDataCallBack=function(t){var e;return this.markerDataArray=t,e=new google.maps.Circle,e.setRadius(t[0].userDistance),e.setCenter(this.user_location),this.map.setCenter(this.user_location),this.map.fitBounds(e.getBounds()),this.drawMarkers()},o.prototype.drawMarkers=function(){var t,e,i,o,n,s;for(n=this.markerDataArray,s=[],i=0,o=n.length;o>i;i++)e=n[i],t=new google.maps.Marker({position:new google.maps.LatLng(e.lat,e.lng),map:this.map,icon:this.pinImage}),s.push(this.setUpMarkerInfoWindow(e,t));return s},o.prototype.setUpMarkerInfoWindow=function(t,e){var i,o,n=this;return i='<div id="content"><h1 id="firstHeading" class="firstHeading">'+t.name+"</h1>"+'<div id="bodyContent">'+'<div class="marker-address">'+t.address+"<br/>"+t.city+"<br/>"+t.zip+"</div>"+"</div>"+"</div>",o=new google.maps.InfoWindow({content:i,maxWidth:200}),google.maps.event.addListener(e,"click",function(){return o.open(n.map,e)})},o.prototype.placesCallback=function(t,e,i){var o,n,s,r;if(o=new google.maps.LatLngBounds,o.extend(this.user_location),e===google.maps.places.PlacesServiceStatus.OK){for(s=0,r=t.length;r>s;s++)n=t[s],o.extend(n.geometry.location),this.createMarker(n);return i||this.map.fitBounds(o),this.isSearching=!1}return this.expandedSearch||e!==google.maps.places.PlacesServiceStatus.ZERO_RESULTS?(this.isSearching=!1,i?void 0:(this.alert("Search Error","No "+this.searchTerm+" found in your area",["OK"],function(){}),this.map.panTo(this.user_location))):(this.expandedSearch=!0,this.findPlaces(5e3))},o.prototype.createMarker=function(t){var e,i,o,n=this;return o=t.geometry.location,e="http://maps.google.com/?daddr="+t.geometry.location.lat()+","+t.geometry.location.lng(),i=new google.maps.Marker({map:this.map,position:t.geometry.location}),google.maps.event.addListener(i,"click",function(){return n.service.getDetails({reference:t.reference},function(t){var o;return o='<div class="infoWindow"><button class="navigate" link="'+e+'">Get Directions</button><h1>'+n.searchTerm+'</h1><div class="address">'+n.formatAddress(t)+"</div></div>",n.infowindow.setContent(o),n.infowindow.open(n.map,i)})})},o.prototype.formatAddress=function(t){var e,i,o,n,s;for(i="",s=t.address_components,o=0,n=s.length;n>o;o++)switch(e=s[o],e.types[0]){case"street_number":i+=e.long_name+" ";break;case"route":i+=e.long_name+"<br>";break;case"locality":i+=e.long_name;break;case"political":i+=e.long_name;break;case"postal_code":i+=", "+e.long_name}return i},o.prototype.radiusFromMap=function(){var t,e,i;return t=this.map.getBounds(),i=t.getSouthWest(),e=t.getNorthEast(),google.maps.geometry.spherical.computeDistanceBetween(i,e)},o}(Tapjoy.AdUnit)}).call(this);